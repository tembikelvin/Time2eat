<?php

namespace Time2Eat\Controllers\Admin;

use controllers\AdminBaseController;

class SettingsController extends AdminBaseController
{
    /**
     * Display settings management page
     */
    public function index()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            $this->redirect(url('/login'));
            return;
        
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            $this->redirect(url('/login'));
            return;
        
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            // Get all settings grouped by category (excluding payment settings)
            $allSettings = $this->fetchAll("
                SELECT `key`, `value`, `type`, `group`, `description`, `is_public`
                FROM site_settings
                WHERE `group` != 'payment'
                ORDER BY `group`, `key`
            ");

            // Group settings by category
            $settings = [];
            foreach ($allSettings as $setting) {
                $settings[$setting['group']][$setting['key']] = $setting;
            
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            // Convert user object to array for view compatibility
            $userData = [
                'id' => $user->id,
                'email' => $user->email,
                'first_name' => $user->first_name,
                'last_name' => $user->last_name,
                'role' => $user->role,
                'status' => $user->status
            ];

            $this->renderDashboard('admin/tools/settings', [
                'title' => 'Site Settings - Time2Eat Admin',
                'user' => $userData,
                'settings' => $settings,
                'currentPage' => 'settings'
            ]);

        
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Error loading settings: " . $e->getMessage());
            $this->redirect(url('/admin/dashboard'));
        
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update settings via API
     */
    public function update()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            foreach ($input as $key => $value) {
                // Validate setting exists
                $setting = $this->fetchOne("SELECT `key`, `type` FROM site_settings WHERE `key` = ?", [$key]);
                
                if (!$setting) {
                    $errors[] = "Setting '$key' not found";
                    continue;
                
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Validate and convert value based on type
                $convertedValue = $this->convertSettingValue($value, $setting['type']);
                
                if ($convertedValue === false) {
                    $errors[] = "Invalid value for setting '$key'";
                    continue;
                
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$convertedValue, $key]);

                $updatedCount++;
            
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => "Successfully updated $updatedCount settings",
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Error updating settings: " . $e->getMessage());
            return $this->json(['error' => 'Failed to update settings'], 500);
        
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Get settings by group via API
     */
    public function getByGroup($group)
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $settings = $this->fetchAll("
                SELECT `key`, `value`, `type`, `description`, `is_public`
                FROM site_settings 
                WHERE `group` = ?
                ORDER BY `key`
            ", [$group]);

            return $this->json([
                'success' => true,
                'data' => $settings
            ]);

        
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Error fetching settings: " . $e->getMessage());
            return $this->json(['error' => 'Failed to fetch settings'], 500);
        
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Reset settings to default values
     */
    public function reset()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $group = $input['group'] ?? '';

        if (empty($group)) {
            return $this->json(['error' => 'Group parameter is required'], 400);
        
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            // Define default values for different groups
            $defaults = $this->getDefaultSettings();

            if (!isset($defaults[$group])) {
                return $this->json(['error' => 'Invalid group'], 400);
            
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            $resetCount = 0;
            foreach ($defaults[$group] as $key => $defaultValue) {
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ? AND `group` = ?
                ", [$defaultValue, $key, $group]);
                $resetCount++;
            
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => "Reset $resetCount settings in '$group' group to defaults"
            ]);

        
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Error resetting settings: " . $e->getMessage());
            return $this->json(['error' => 'Failed to reset settings'], 500);
        
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Convert setting value based on type
     */
    private function convertSettingValue($value, $type)
    {
        switch ($type) {
            case 'boolean':
                return $value === 'true' || $value === '1' || $value === 1 ? 'true' : 'false';
            case 'integer':
                return is_numeric($value) ? (string)intval($value) : false;
            case 'float':
                return is_numeric($value) ? (string)floatval($value) : false;
            case 'json':
                $decoded = json_decode($value, true);
                return $decoded !== null ? json_encode($decoded) : false;
            case 'string':
            case 'text':
            default:
                return (string)$value;
        
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Get default settings values
     */
    private function getDefaultSettings()
    {
        return [
            'general' => [
                'site_name' => 'Time2Eat',
                'site_description' => 'Bamenda Food Delivery Platform',
                'timezone' => 'Africa/Douala'
            ],
            'contact' => [
                'contact_email' => 'info@time2eat.cm',
                'contact_phone' => '+237 6XX XXX XXX',
                'contact_address' => 'Bamenda, North West Region, Cameroon',
                'contact_hours' => 'Mon-Sat: 8AM-10PM, Sun: 10AM-8PM',
                'support_email' => 'support@time2eat.cm',
                'emergency_contact' => '+237 6XX XXX XXX'
            ],
            'social' => [
                'facebook_url' => '',
                'twitter_url' => '',
                'instagram_url' => '',
                'youtube_url' => '',
                'linkedin_url' => '',
                'tiktok_url' => '',
                'whatsapp_number' => ''
            ],
            'business' => [
                'delivery_fee' => '500',
                'free_delivery_threshold' => '5000',
                'commission_rate' => '0.15',
                'tax_rate' => '0.1925',
                'currency' => 'XAF',
                'max_delivery_distance' => '15'
            ],
            'seo' => [
                'meta_keywords' => 'food delivery, Bamenda, restaurants, online ordering',
                'google_analytics_id' => '',
                'facebook_pixel_id' => ''
            ],
            'auth' => [
                'allow_registration' => 'true',
                'email_verification_required' => 'true'
            ],
            'system' => [
                'maintenance_mode' => 'false'
            ],
            'maps' => [
                'map_provider' => 'leaflet',
                'google_maps_api_key' => '',
                'mapbox_access_token' => '',
                'default_latitude' => '5.9631',
                'default_longitude' => '10.1591',
                'default_zoom_level' => '13',
                'enable_location_tracking' => 'true'
            ],
            'payment' => [
                'payment_methods_enabled' => '["cash","mobile_money","orange_money","mtn_momo"]',
                'cash_on_delivery_enabled' => 'true',
                'online_payment_enabled' => 'true',
                'stripe_publishable_key' => '',
                'stripe_secret_key' => '',
                'paypal_client_id' => '',
                'paypal_client_secret' => '',
                'paypal_sandbox_mode' => 'true',
                'orange_money_merchant_id' => '',
                'orange_money_api_key' => '',
                'mtn_momo_api_key' => '',
                'mtn_momo_user_id' => '',
                'payment_processing_fee' => '0.025',
                'minimum_order_amount' => '1000'
            ],
            'currency' => [
                'primary_currency' => 'XAF',
                'currency_symbol' => 'FCFA',
                'currency_position' => 'after',
                'decimal_places' => '0',
                'thousand_separator' => ',',
                'decimal_separator' => '.',
                'exchange_rate_usd' => '600',
                'auto_update_exchange_rates' => 'false'
            ]
        ];
    
    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update email verification settings
     */
    public function updateEmailVerification()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->json(['error' => 'Unauthorized'], 401);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->json(['error' => 'Forbidden'], 403);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        // Get input data
        $input = $_POST;
        if (empty($input)) {
            $input = json_decode(file_get_contents('php://input'), true) ?? [];
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        if (empty($input)) {
            return $this->json(['error' => 'No data provided'], 400);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

        try {
            $updatedCount = 0;
            $errors = [];

            // Validate email verification settings
            $emailVerificationSettings = [
                'email_verification_required',
                'email_verification_method',
                'email_verification_expiry',
                'registration_enabled',
                'auto_approve_customers'
            ];

            foreach ($emailVerificationSettings as $key) {
                if (!isset($input[$key])) {
                    continue;
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                $value = $input[$key];

                // Validate specific settings
                if ($key === 'email_verification_required' || $key === 'registration_enabled' || $key === 'auto_approve_customers') {
                    $value = filter_var($value, FILTER_VALIDATE_BOOLEAN) ? '1' : '0';
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_method') {
                    if (!in_array($value, ['code', 'link'])) {
                        $errors[] = "Invalid verification method for '$key'";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} elseif ($key === 'email_verification_expiry') {
                    $value = (int)$value;
                    if ($value < 1 || $value > 168) { // 1 hour to 1 week
                        $errors[] = "Invalid expiry time for '$key' (must be 1-168 hours)";
                        continue;
                    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
                
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

                // Update setting
                $this->execute("
                    UPDATE site_settings 
                    SET `value` = ?, `updated_at` = NOW() 
                    WHERE `key` = ?
                ", [$value, $key]);

                $updatedCount++;
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            if (!empty($errors)) {
                return $this->json([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors,
                    'updated_count' => $updatedCount
                ], 400);
            
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

            return $this->json([
                'success' => true,
                'message' => 'Email verification settings updated successfully',
                'updated_count' => $updatedCount
            ]);

        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
} catch (\Exception $e) {
            error_log("Email verification settings update error: " . $e->getMessage());
            return $this->json([
                'success' => false,
                'message' => 'Failed to update email verification settings',
                'error' => $e->getMessage()
            ], 500);
        
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
    
    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}

    /**
     * Update authentication settings
     */
    public function updateAuthSettings()
    {
        // Check authentication and role
        if (!$this->isAuthenticated()) {
            return $this->jsonResponse(['success' => false, 'message' => 'Unauthorized'], 401);
        }

        $user = $this->getCurrentUser();
        if (!$user || $user->role !== 'admin') {
            return $this->jsonResponse(['success' => false, 'message' => 'Forbidden'], 403);
        }

        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            return $this->jsonResponse(['success' => false, 'message' => 'Method not allowed'], 405);
        }

        try {
            require_once __DIR__ . '/../../models/SiteSetting.php';
            $siteSetting = new \Time2Eat\Models\SiteSetting();
            
            $updatedSettings = [];
            $errors = [];
            
            // Get form data
            $input = $_POST;
            if (empty($input)) {
                $input = json_decode(file_get_contents('php://input'), true) ?? [];
            }
            
            // Validate and update email verification settings
            $authSettings = [
                'email_verification_required',
                'registration_enabled',
                'auto_approve_customers',
                'email_verification_method',
                'email_verification_expiry'
            ];
            
            foreach ($authSettings as $key) {
                if (isset($input[$key])) {
                    $value = $input[$key];
                    
                    // Convert checkbox values to boolean
                    if (in_array($key, ['email_verification_required', 'registration_enabled', 'auto_approve_customers'])) {
                        $value = ($value === 'true' || $value === true || $value === '1' || $value === 1) ? 'true' : 'false';
                    }
                    
                    // Validate email verification expiry
                    if ($key === 'email_verification_expiry') {
                        $value = max(1, min(168, (int)$value)); // Between 1 and 168 hours (1 week)
                    }
                    
                    // Validate email verification method
                    if ($key === 'email_verification_method') {
                        if (!in_array($value, ['token', 'code'])) {
                            $value = 'token';
                        }
                    }
                    
                    if ($siteSetting->updateSetting($key, $value)) {
                        $updatedSettings[] = $key;
                    } else {
                        $errors[] = "Failed to update {$key}";
                    }
                }
            }
            
            if (!empty($errors)) {
                return $this->jsonResponse([
                    'success' => false,
                    'message' => 'Some settings could not be updated',
                    'errors' => $errors
                ], 400);
            }
            
            // Log the settings update
            error_log("Auth settings updated by admin {$user->id}: " . implode(', ', $updatedSettings));
            
            return $this->jsonResponse([
                'success' => true,
                'message' => 'Authentication settings updated successfully',
                'updated_settings' => $updatedSettings
            ]);
            
        } catch (Exception $e) {
            error_log("Error updating auth settings: " . $e->getMessage());
            return $this->jsonResponse([
                'success' => false,
                'message' => 'An error occurred while updating settings'
            ], 500);
        }
    }
}
